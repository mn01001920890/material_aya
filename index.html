<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Science • Theme 3 • Concept 3.1</title>

  <style>
    :root{
      --bgSolid:#4aa3ff;

      --card: rgba(255,255,255,.94);
      --card2: rgba(255,255,255,.86);
      --line: rgba(15,45,95,.14);

      --text:#0b2453;
      --muted:#3d5f9d;

      --accent:#1d4ed8;

      --good:#10b981;
      --bad:#ef4444;

      --shadow: 0 18px 50px rgba(11,36,80,.16);
      --radius: 18px;

      --h1: clamp(22px, 2.8vw, 30px);
      --h2: clamp(18px, 2.2vw, 22px);
      --base: 17px;
      --small: 14px;
      --lh: 1.75;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      font-size: var(--base);
      line-height: var(--lh);
      background: var(--bgSolid);
    }

    header{
      position: fixed; top:0; left:0; right:0; z-index:1000;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.72);
      border-bottom: 1px solid rgba(15,45,95,.18);
    }
    .topbar{
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 14px;
      padding-top: 92px;
    }

    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:46px; height:46px;
      border-radius: 16px;
      background: rgba(29,78,216,.18);
      border:1px solid rgba(29,78,216,.20);
      display:grid; place-items:center;
      font-weight: 950;
      color:#123a87;
      box-shadow: 0 12px 26px rgba(29,78,216,.14);
      user-select:none;
      font-size: 18px;
    }
    .brandText h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      line-height: 1.2;
      font-weight: 950;
    }
    .brandText .sub{
      margin:3px 0 0;
      font-size: var(--small);
      color: var(--muted);
      font-weight: 900;
    }

    .navRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    select{
      border:1px solid rgba(15,45,95,.18);
      border-radius: 999px;
      padding: 11px 14px;
      background: rgba(255,255,255,.90);
      color: var(--text);
      font-weight: 950;
      outline:none;
      box-shadow: 0 10px 26px rgba(11,36,80,.10);
      max-width: 380px;
      font-size: 15px;
    }

    .btn{
      border:1px solid rgba(15,45,95,.18);
      background: rgba(255,255,255,.90);
      color: var(--text);
      border-radius: 999px;
      padding: 11px 14px;
      cursor:pointer;
      font-weight: 950;
      transition: .15s ease;
      box-shadow: 0 10px 26px rgba(11,36,80,.10);
      user-select:none;
      white-space: nowrap;
      font-size: 15px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: rgba(29,78,216,.92);
      border-color: rgba(29,78,216,.25);
      color:#fff;
    }
    .btn.ghost{
      background: rgba(255,255,255,.70);
    }

    .screen{ display:none; animation: fade .18s ease-out; }
    .screen.active{ display:block; }
    @keyframes fade{ from{ opacity:.6; transform: translateY(4px);} to{opacity:1; transform:none;} }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: var(--h2);
      letter-spacing: .2px;
      font-weight: 950;
    }
    .muted{ color: var(--muted); font-weight: 900; }

    .heroTitle{
      font-size: var(--h1);
      font-weight: 950;
      margin: 0;
      letter-spacing:.2px;
      line-height: 1.2;
    }
    .bigQ{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px dashed rgba(29,78,216,.30);
      background: rgba(29,78,216,.10);
      color:#123a87;
      font-weight: 950;
      font-size: 16px;
    }

    .modeButtons{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 12px 0 6px;
    }

    .grid{ display:grid; gap: 14px; grid-template-columns: 1fr; }

    .block{
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(15,45,95,.12);
      border-radius: 16px;
      padding: 14px;
      margin: 12px 0;
    }
    .blockTitle{
      margin:0 0 10px;
      font-weight: 950;
      color:#0f2d5f;
      letter-spacing:.2px;
      font-size: 18px;
    }
    ul{ margin: 8px 0 0 18px; }
    li{ margin: 8px 0; }

    .imgBox{
      margin-top: 12px;
      border-radius: 16px;
      border:1px solid rgba(15,45,95,.12);
      background: rgba(255,255,255,.86);
      padding: 12px;
    }
    .imgBox img{
      width:100%;
      display:block;
      border-radius: 14px;
      background:#fff;
      border:1px solid rgba(15,45,95,.10);
    }
    .cap{
      margin-top: 10px;
      font-size: 15px;
      color: var(--muted);
      font-weight: 950;
    }

    .quizTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 10px 0 2px;
    }
    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(15,45,95,.14);
      background: rgba(255,255,255,.88);
      font-weight: 950;
      color:#0f2d5f;
      font-size: 15px;
    }
    .pill.good{ border-color: rgba(16,185,129,.25); }
    .pill.bad{ border-color: rgba(239,68,68,.25); }
    .pill.small{ color: var(--muted); }

    .qCard{
      background: var(--card2);
      border: 1px solid rgba(15,45,95,.12);
      border-radius: 18px;
      padding: 14px;
      margin: 14px 0;
    }
    .qTitle{
      margin:0 0 10px;
      font-weight: 950;
      color:#0f2d5f;
      letter-spacing:.1px;
      font-size: 18px;
    }

    .optBtn{
      width:100%;
      text-align:left;
      border:1px solid rgba(15,45,95,.14);
      background: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 12px 14px;
      margin: 10px 0;
      cursor:pointer;
      font-weight: 950;
      color:#0d2450;
      transition:.15s;
      font-size: 16px;
    }
    .optBtn:hover{ transform: translateY(-1px); }
    .optBtn:disabled{ opacity:.84; cursor:not-allowed; }

    .feedback{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(15,45,95,.14);
      background: rgba(255,255,255,.88);
      line-height: 1.65;
      display:none;
      font-weight: 900;
      font-size: 16px;
    }
    .feedback.good{
      display:block;
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.12);
    }
    .feedback.bad{
      display:block;
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
    }

    footer{
      text-align:center;
      color: rgba(15,45,95,.78);
      padding: 18px 10px 36px;
      font-weight: 950;
      font-size: 15px;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">S</div>
      <div class="brandText">
        <h1 id="appTitle">Science Lesson App</h1>
        <div class="sub" id="appSub">Theme 3 • Concept 3.1</div>
      </div>
    </div>

    <div class="navRow">
      <select id="lessonSelect"></select>
      <button class="btn ghost" id="homeBtn">Home</button>
      <button class="btn" id="resetAttemptBtn">Reset Attempt</button>
    </div>
  </div>
</header>

<main>
  <section class="screen active" id="screenHome">
    <div class="card">
      <h2>Index</h2>
      <div class="muted">Choose a lesson from the top list to open it.</div>
      <div id="homeList" style="margin-top:12px;"></div>
    </div>
  </section>

  <section class="screen" id="screenLesson">
    <div class="grid">
      <div class="card">
        <h2 class="heroTitle" id="lessonTitle">Lesson</h2>
        <div class="bigQ" id="bigQ"></div>

        <div class="modeButtons">
          <button class="btn primary" id="btnExplain">Explanation</button>
          <button class="btn" id="btnMCQ">MCQ Quiz</button>
          <button class="btn" id="btnTF">True/False</button>
        </div>

        <div id="lessonContent"></div>
      </div>
    </div>
  </section>

  <footer>Mobile-friendly • Clear fonts • Instant feedback quizzes</footer>
</main>

<script type="module">

  import { COURSE as COURSE_L1 } from "./lesson1-data.js";

  import { COURSE as COURSE_31_L2 } from "./lesson2-data.js";
  import { COURSE as COURSE_31_L3 } from "./lesson3-data.js";
  import { COURSE as COURSE_31_L4 } from "./lesson4-data.js";

  import { COURSE as COURSE_32_L1 } from "./lesson1-data_concept3.2.js";
  import { COURSE as COURSE_32_L2 } from "./lesson2-data_concept3.2.js";
  import { COURSE as COURSE_32_L3 } from "./lesson3-data_concept3.2.js";
  import { COURSE as COURSE_32_L4 } from "./lesson4-data_concept3.2.js";
  import { COURSE as COURSE_32_L5 } from "./lesson5-data_concept3.2.js";

  import { COURSE as COURSE_33_L1 } from "./lesson1-data_concept3.3.js";
  import { COURSE as COURSE_33_L2 } from "./lesson2-data_concept3.3.js";
  import { COURSE as COURSE_33_L3 } from "./lesson3-data_concept3.3.js";
  import { COURSE as COURSE_33_L4 } from "./lesson4-data_concept3.3.js";

  // اجمعهم في قائمة
  const ALL = [
    COURSE_L1,
    COURSE_31_L2, COURSE_31_L3, COURSE_31_L4,
    COURSE_32_L1, COURSE_32_L2, COURSE_32_L3, COURSE_32_L4, COURSE_32_L5,
    COURSE_33_L1, COURSE_33_L2, COURSE_33_L3, COURSE_33_L4
  ].filter(Boolean);

  // دمج nav.lessons و lessons من كل ملف
  const COURSE = {
    appTitle: ALL.find(x => x?.appTitle)?.appTitle || "Science Lesson App",
    nav: {
      conceptTitle: "All Concepts",
      lessons: ALL.flatMap(x => x?.nav?.lessons || [])
    },
    lessons: Object.assign({}, ...ALL.map(x => x?.lessons || {}))
  };

  // كمل كودك عادي تحت...





  const $ = (id) => document.getElementById(id);

  const screens = { home: $("screenHome"), lesson: $("screenLesson") };
  function showScreen(name){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[name].classList.add("active");
    window.scrollTo({ top: 0, behavior: "instant" });
  }

  // ✅ TEMP ONLY: sessionStorage clears on refresh/new tab session
  function key(lessonId){ return `SCI_SESSION_ATTEMPT__${lessonId}`; }

  function loadAttempt(lessonId){
    const base = { mcq:{correct:0,wrong:0,answered:{}}, tf:{correct:0,wrong:0,answered:{}} };
    try{
      const raw = sessionStorage.getItem(key(lessonId));   // ✅ changed
      return raw ? { ...base, ...JSON.parse(raw) } : base;
    }catch{ return base; }
  }

  function saveAttempt(lessonId, attempt){
    sessionStorage.setItem(key(lessonId), JSON.stringify(attempt)); // ✅ changed
  }

  function resetAttempt(lessonId){
    sessionStorage.removeItem(key(lessonId)); // ✅ changed
  }

  $("appTitle").textContent = COURSE.appTitle || "Science Lesson App";
  $("appSub").textContent = `Theme 3 • ${COURSE.nav?.conceptTitle || "Concept 3.1"}`;

  const select = $("lessonSelect");
  const lessons = COURSE.nav?.lessons || [];
  select.innerHTML = `<option value="">Select lesson…</option>` + lessons.map(l =>
    `<option value="${l.id}">${l.label}</option>`
  ).join("");

  const homeList = $("homeList");
  homeList.innerHTML = "";
  lessons.forEach(l => {
    const div = document.createElement("div");
    div.className = "block";
    div.innerHTML = `
      <div class="blockTitle">${l.label}</div>
      <div class="muted">${l.short || ""}</div>
      <div style="margin-top:10px;">
        <button class="btn primary" data-open="${l.id}">Open Lesson</button>
      </div>
    `;
    div.querySelector("[data-open]").addEventListener("click", () => openLesson(l.id));
    homeList.appendChild(div);
  });

  $("homeBtn").addEventListener("click", () => {
    select.value = "";
    showScreen("home");
  });

  let currentLessonId = null;

  $("resetAttemptBtn").addEventListener("click", () => {
    if(!currentLessonId){ alert("Open a lesson first."); return; }
    resetAttempt(currentLessonId);
    renderExplanation(currentLessonId);
    alert("Attempt reset ✅");
  });

  select.addEventListener("change", () => {
    const id = select.value;
    if(id) openLesson(id);
  });

  function openLesson(lessonId){
    const lesson = COURSE.lessons?.[lessonId];
    if(!lesson){ alert("Lesson data not found."); return; }
    currentLessonId = lessonId;

    showScreen("lesson");
    $("lessonTitle").textContent = lesson.title || "Lesson";
    $("bigQ").textContent = "Big Question: " + (lesson.bigQuestion || "");

    $("btnExplain").onclick = () => renderExplanation(lessonId);
    $("btnMCQ").onclick = () => renderMCQ(lessonId);
    $("btnTF").onclick = () => renderTF(lessonId);

    renderExplanation(lessonId);
  }

  function renderExplanation(lessonId){
    const lesson = COURSE.lessons[lessonId];
    const wrap = $("lessonContent");
    wrap.innerHTML = "";

    (lesson.explanationBlocks || []).forEach(blockData => {
      const block = document.createElement("div");
      block.className = "block";
      block.innerHTML = `
        <div class="blockTitle">${blockData.title}</div>
        <ul>${(blockData.bullets||[]).map(x => `<li>${x}</li>`).join("")}</ul>
      `;

      if(blockData.image?.src){
        const imgBox = document.createElement("div");
        imgBox.className = "imgBox";
        imgBox.innerHTML = `
          <img src="${blockData.image.src}" alt="lesson sketch"/>
          <div class="cap">${blockData.image.caption || ""}</div>
        `;
        block.appendChild(imgBox);
      }

      wrap.appendChild(block);
    });
  }

  function renderMCQ(lessonId){
    const lesson = COURSE.lessons[lessonId];
    const wrap = $("lessonContent");
    wrap.innerHTML = "";

    const attempt = loadAttempt(lessonId);
    const qs = lesson.mcq?.questions || [];

    const top = document.createElement("div");
    top.className = "quizTop";
    top.innerHTML = `
      <div class="pill good">Correct: <span id="mcqC">${attempt.mcq.correct}</span></div>
      <div class="pill bad">Wrong: <span id="mcqW">${attempt.mcq.wrong}</span></div>
      <div class="pill small">Answered: <span id="mcqA">${Object.keys(attempt.mcq.answered).length}</span> / ${qs.length}</div>
    `;
    wrap.appendChild(top);

    qs.forEach(q => {
      const qc = document.createElement("div");
      qc.className = "qCard";

      const prev = attempt.mcq.answered[q.id];
      const fbClass = prev ? (prev.correct ? "good" : "bad") : "";
      const fbText = prev
        ? (prev.correct
          ? `<b>✅ Correct! (تمام صح)</b><br/>Why: ${q.whyCorrect || "This matches the lesson idea."}`
          : `<b>❌ Wrong (خطأ)</b><br/>Correct Answer: <b>${q.correctKey}</b><br/>Why: ${q.whyCorrect || "This is what the lesson explains."}`)
        : "";

      qc.innerHTML = `
        <div class="qTitle">${q.id}) ${q.q}</div>
        <div class="opts"></div>
        <div class="feedback ${fbClass}" id="fb-mcq-${q.id}">${fbText}</div>
      `;

      const opts = qc.querySelector(".opts");
      (q.options || []).forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "optBtn";
        btn.textContent = `${opt.key}) ${opt.text}`;
        btn.disabled = !!prev;

        btn.addEventListener("click", () => {
          const now = loadAttempt(lessonId);
          if(now.mcq.answered[q.id]) return;

          const isCorrect = opt.key === q.correctKey;
          now.mcq.answered[q.id] = { chosen: opt.key, correct: isCorrect, ts: Date.now() };
          if(isCorrect) now.mcq.correct += 1;
          else now.mcq.wrong += 1;

          saveAttempt(lessonId, now);

          const fb = $("fb-mcq-" + q.id);
          fb.classList.remove("good","bad");
          fb.classList.add(isCorrect ? "good" : "bad");
          fb.innerHTML = isCorrect
            ? `<b>✅ Correct! (تمام صح)</b><br/>Why: ${q.whyCorrect || "This matches the lesson idea."}`
            : `<b>❌ Wrong (خطأ)</b><br/>Correct Answer: <b>${q.correctKey}</b><br/>Why: ${q.whyCorrect || "This is what the lesson explains."}`;

          opts.querySelectorAll("button").forEach(b => b.disabled = true);

          $("mcqC").textContent = now.mcq.correct;
          $("mcqW").textContent = now.mcq.wrong;
          $("mcqA").textContent = Object.keys(now.mcq.answered).length;
        });

        opts.appendChild(btn);
      });

      wrap.appendChild(qc);
    });
  }

  function renderTF(lessonId){
    const lesson = COURSE.lessons[lessonId];
    const wrap = $("lessonContent");
    wrap.innerHTML = "";

    const attempt = loadAttempt(lessonId);
    const qs = lesson.tf?.questions || [];

    const top = document.createElement("div");
    top.className = "quizTop";
    top.innerHTML = `
      <div class="pill good">Correct: <span id="tfC">${attempt.tf.correct}</span></div>
      <div class="pill bad">Wrong: <span id="tfW">${attempt.tf.wrong}</span></div>
      <div class="pill small">Answered: <span id="tfA">${Object.keys(attempt.tf.answered).length}</span> / ${qs.length}</div>
    `;
    wrap.appendChild(top);

    qs.forEach(q => {
      const qc = document.createElement("div");
      qc.className = "qCard";

      const prev = attempt.tf.answered[q.id];
      const fbClass = prev ? (prev.correct ? "good" : "bad") : "";
      const fbText = prev
        ? (prev.correct
          ? `<b>✅ Correct! (تمام صح)</b><br/>Why: ${q.reason || "This matches the lesson explanation."}`
          : `<b>❌ Wrong (خطأ)</b><br/>Correct Answer: <b>${q.correct ? "True" : "False"}</b><br/>Why: ${q.reason || "This is what the lesson explains."}`)
        : "";

      qc.innerHTML = `
        <div class="qTitle">${q.id}) ${q.s}</div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
          <button class="optBtn" style="max-width:220px" data-v="true">True</button>
          <button class="optBtn" style="max-width:220px" data-v="false">False</button>
        </div>
        <div class="feedback ${fbClass}" id="fb-tf-${q.id}">${fbText}</div>
      `;

      const btns = qc.querySelectorAll("button.optBtn");
      btns.forEach(b => {
        b.disabled = !!prev;

        b.addEventListener("click", () => {
          const now = loadAttempt(lessonId);
          if(now.tf.answered[q.id]) return;

          const chosen = b.dataset.v === "true";
          const isCorrect = chosen === q.correct;

          now.tf.answered[q.id] = { chosen, correct: isCorrect, ts: Date.now() };
          if(isCorrect) now.tf.correct += 1;
          else now.tf.wrong += 1;

          saveAttempt(lessonId, now);

          const fb = $("fb-tf-" + q.id);
          fb.classList.remove("good","bad");
          fb.classList.add(isCorrect ? "good" : "bad");
          fb.innerHTML = isCorrect
            ? `<b>✅ Correct! (تمام صح)</b><br/>Why: ${q.reason || "This matches the lesson idea."}`
            : `<b>❌ Wrong (خطأ)</b><br/>Correct Answer: <b>${q.correct ? "True" : "False"}</b><br/>Why: ${q.reason || "This is what the lesson explains."}`;

          btns.forEach(x => x.disabled = true);

          $("tfC").textContent = now.tf.correct;
          $("tfW").textContent = now.tf.wrong;
          $("tfA").textContent = Object.keys(now.tf.answered).length;
        });
      });

      wrap.appendChild(qc);
    });
  }

  showScreen("home");
</script>
</body>
</html>
